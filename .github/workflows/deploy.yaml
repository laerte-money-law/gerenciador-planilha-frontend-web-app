name: Deploy to Firebase Hosting

on:
    push:
        branches:
            - main

jobs:
    build-and-deploy-qa:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v3

            - name: Setup Node
              uses: actions/setup-node@v3
              with:
                  node-version: "18"

            - name: Install dependencies
              run: npm ci

            - name: Install Firebase CLI
              run: npm install -g firebase-tools

            - name: Build Angular App (QA)
              run: npm run build:qa

            - name: Deploy to Firebase QA
              env:
                  FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
              run: firebase deploy --only hosting:qa

    build-prod:
        runs-on: ubuntu-latest
        needs: build-and-deploy-qa
        outputs:
            artifact-name: prod-build
        steps:
            - uses: actions/checkout@v3

            - name: Setup Node
              uses: actions/setup-node@v3
              with:
                  node-version: "18"

            - name: Install dependencies
              run: npm ci

            - name: Build Angular App (PROD)
              run: npm run build:prod

            - name: Upload build artifact
              uses: actions/upload-artifact@v4
              with:
                  name: prod-build
                  path: dist

    manual-approval:
        runs-on: ubuntu-latest
        needs: build-prod
        outputs:
            approved: ${{ steps.approval.outputs.approved }}
        permissions:
            issues: write
        steps:
            - name: Await Manual Approval
              id: approval
              uses: trstringer/manual-approval@v1
              with:
                  secret: ${{ secrets.GITHUB_TOKEN }}
                  approvers: raphaelcomph-dev,laerte-money-law
                  minimum-approvals: 1
                  issue-title: "Manual Approval Required for PROD Deployment"
                  issue-body: "Please comment 'approve' or 'deny' to control the production deploy."
                  exclude-denied: true # ⬅️ This is the key: fail the step if denied

    deploy-prod:
        runs-on: ubuntu-latest
        needs: manual-approval
        if: needs.manual-approval.result == 'success'
        steps:
            - uses: actions/checkout@v3

            - name: Setup Node
              uses: actions/setup-node@v3
              with:
                  node-version: "18"

            - name: Install Firebase CLI
              run: npm install -g firebase-tools

            - name: Download build artifact
              uses: actions/download-artifact@v4
              with:
                  name: prod-build
                  path: dist

            - name: Deploy to Firebase PROD
              env:
                  FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
              run: firebase deploy --only hosting:prod
